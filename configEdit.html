<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>编辑配置表</title>
</head>
<body>
    <h1>编辑的哪个文件夹下的名字</h1>
    <table id="table1Node" border="5px">
        <tbody>
        <tr>
            <td><textarea>第一个格子输入标题头</textarea></td>
            <td><textarea>第二个之后的格子随便输入些什么都行</textarea></td>
        </tr>
        </tbody>
    </table>
    <button onclick="addRow()">增加新的一行</button>
    <button onclick="addCol()">增加新的一列</button>
    <button onclick="cutRow()">删除最后一行</button>
    <button onclick="cutCol()">删除最后一列</button>
    <p></p><p></p><p></p><p></p><p></p>
    <table id="table2Node" border="5px">
        <tbody></tbody>
    </table>
    <button onclick="addRow2()">增加一个新枚举</button>
    <button onclick="cutRow2()">删除最后的枚举</button>
    <p></p>
    选择csv的分隔符:<select>
        <option>,</option>
        <option>.</option>
        <option>|</option>
    </select>
    <p><button onclick="save()">保存</button></p>
    <script src="src/LocalData.js"></script>
    <script>

        var win=nw.Window.get();
        win.showDevTools();
        win.width= 1280;
        win.height=720;
        win.setPosition('center');
//        win.on('close',function () {
//           nw.Window.open('csvEdit.html');
//            win.close(true);
//        });

        LocalData.init();
        var oldConfigObj=null;


        var h1Node=document.body.querySelector('h1');
        h1Node.textContent="文件夹:"+LocalData.currentCsvDir;

        var table1Node=document.getElementById('table1Node');
        function createRow(colNums) {
            var tr=document.createElement('tr');

            if(typeof colNums == 'number') {

                for (var i = 0; i < colNums; i++) {
                    var td = document.createElement('td');
                    var textarea = document.createElement('textarea');
                    textarea.placeholder = '请输入内容';
                    if (i == 0) textarea.placeholder = '本格子内容不能为空';
                    td.appendChild(textarea);
                    tr.appendChild(td);
                }
            }
            else
            {
                for (var i = 0; i < colNums.length; i++) {
                    var td = document.createElement('td');
                    var textarea = document.createElement('textarea');
                    textarea.placeholder = '请输入内容';
                    if (i == 0) textarea.placeholder = '本格子内容不能为空';
                    textarea.value=colNums[i];
                    td.appendChild(textarea);
                    tr.appendChild(td);
                }
            }
            return tr;
        }

        function addRow() {
            var colNums=table1Node.querySelector('tbody').querySelector('tr').querySelectorAll('td').length;
            var tr=createRow(colNums);
            table1Node.querySelector('tbody').appendChild(tr);
        }

        function addCol() {

            var allTr=table1Node.querySelector('tbody').querySelectorAll('tr')
            allTr.forEach(function (tr) {
                var td=document.createElement('td');
                var textarea=document.createElement('textarea');
                textarea.placeholder='请输入内容';
                td.appendChild(textarea);
                tr.appendChild(td);
            })
        }

        function cutRow() {
            var allTr=table1Node.querySelector('tbody').querySelectorAll('tr')
            table1Node.querySelector('tbody').removeChild(allTr[allTr.length-1]);
        }

        function cutCol() {
            var allTr=table1Node.querySelector('tbody').querySelectorAll('tr')
            allTr.forEach(function (tr) {
                var allTd=tr.querySelectorAll('td');
                tr.removeChild(allTd[allTd.length-1]);
            })
        }

        function save() {
            //rows
            var rows={};
            var table1tbody=table1Node.querySelector('tbody');
            var table1AllTr=table1tbody.querySelectorAll('tr');
            table1AllTr.forEach(function (eachTr) {

                var allTd=eachTr.querySelectorAll('td');
                var stringArray=[];
                allTd.forEach(function (eachTd,pos) {
                    var textarea= eachTd.querySelector('textarea');
                    if(pos==0 && textarea.value == '')alert('出错了:每行的头元素必须不能为空');
                    stringArray.push(textarea.value);
                })
                rows[stringArray[0]]=stringArray;
            });


            //cellEnum
            var cellEnum={};
            var table2tbody=table2Node.querySelector('tbody');
            var table2AllTr=table2tbody.querySelectorAll('tr');
            table2AllTr.forEach(function (eachTr) {

                var stringArray=[];
                var allTd=eachTr.querySelectorAll('td');
                //跳过最后的两个按钮
                for(var i=0;i<allTd.length-2;i++)
                {
                    var textarea=allTd[i].querySelector('textarea');
                    stringArray.push(textarea.value);
                }
                var key=stringArray.shift();
                cellEnum[key]=stringArray;
            });

            //splitChar
            var splitChar=document.body.querySelector('select').value;

            var obj={};

            obj.rows=rows;
            obj.cellEnum=cellEnum;
            obj.splitChar=splitChar;


            var confirmString='';

            if(oldConfigObj !=null)
            {
                var oldowsKey=getKeys(oldConfigObj.rows);
                var deleteKey=[];
                for(var i=0;i<oldowsKey.length;i++)
                {
                    if(obj.rows[oldowsKey[i]] == null)
                            deleteKey.push(oldowsKey[i]);
                }

                if(deleteKey.length!=0)
                {
                    var deletArray=deleteKey.join(',');
                    confirmString=confirmString+'系统检测到以下的头部字段已经被删除:'+deletArray;
                }

                if(oldConfigObj.splitChar != obj.splitChar)
                        confirmString=confirmString+'\n'+'系统检测到你更改了文件分隔符';


                if(confirmString!='')
                {
                    var ret=window.confirm(confirmString+'\n可能导致已经保存的csv文件打开失败,是否继续?');
                    if(ret)
                    {
                        var writeString = JSON.stringify(obj,null,2);
                        var fs=require('fs');
                        fs.writeFileSync(LocalData.currentCsvDir+'/config.json',writeString);
                        oldConfigObj=obj;
                        alert('保存配置表成功');
                    }
                    else
                    {

                    }
                }
                else
                {
                    var writeString = JSON.stringify(obj,null,2);
                    var fs=require('fs');
                    fs.writeFileSync(LocalData.currentCsvDir+'/config.json',writeString);
                    oldConfigObj=obj;
                    alert('保存配置表成功');
                }
            }
            else
            {
                var writeString = JSON.stringify(obj,null,2);
                var fs=require('fs');
                fs.writeFileSync(LocalData.currentCsvDir+'/config.json',writeString);
                oldConfigObj=obj;
                alert('保存配置表成功');
            }
        }


        var table2Node=document.getElementById('table2Node');
        function createRow2(headName,stringArray) {

            var tr = document.createElement('tr');
                var td1 = document.createElement('td');
                var textarea = document.createElement('textarea');
                textarea.placeholder = '请输入枚举的名字';
                if(typeof headName =='string')
                        textarea.value=headName;
                td1.appendChild(textarea);
                tr.appendChild(td1);

        if(typeof stringArray != 'undefined') {
            for (var i = 0; i < stringArray.length; i++) {
                var td1 = document.createElement('td');
                var textarea = document.createElement('textarea');
                textarea.placeholder = '请输入枚举的名字';
                textarea.value = stringArray[i];
                td1.appendChild(textarea);
                tr.appendChild(td1);
            }
        }

            var tdDelete=document.createElement('td');
            var buttonDelete=document.createElement('button');
            buttonDelete.textContent='删除最后一个枚举选项';
            buttonDelete.addEventListener('click',function (event) {
                if(tr.querySelectorAll('td').length>3)
                {
                    var removeTd=tdDelete.previousSibling;
                    tr.removeChild(removeTd);
                }
            });
            tdDelete.appendChild(buttonDelete);
            tr.appendChild(tdDelete);


            var tdAdd=document.createElement('td');
            var buttonAdd=document.createElement('button');
            buttonAdd.textContent='新增一个枚举选项';
            buttonAdd.addEventListener('click',function (event) {
                var tdOption=document.createElement('td');
                var textarea=document.createElement('textarea');
                textarea.placeholder='请输入枚举选项名字';
                tdOption.appendChild(textarea);
                tr.insertBefore(tdOption,tdDelete);
            });
            tdAdd.appendChild(buttonAdd);
            tr.appendChild(tdAdd);

            return tr;
        }


        function addRow2() {
            var tr=createRow2();
            table2Node.querySelector('tbody').appendChild(tr);
        }

        function cutRow2()
        {
            var allTr=table2Node.querySelector('tbody').querySelectorAll('tr');
            table2Node.querySelector('tbody').removeChild(allTr[allTr.length-1]);
        }



        var fs=require('fs');
        if(fs.existsSync(LocalData.currentCsvDir+'/config.json'))
        {
            //对已经存在的模板进行编辑
            var configString=fs.readFileSync(LocalData.currentCsvDir+'/config.json','utf8');
            oldConfigObj=JSON.parse(configString);

            var table1tbody=table1Node.querySelector('tbody');
            while (table1tbody.childNodes.length!=0) table1tbody.removeChild(table1tbody.firstChild);
            var table2tbody=table2Node.querySelector('tbody');
            while (table2tbody.childNodes.length!=0) table2tbody.removeChild(table2tbody.firstChild);

            //初始化table1
            for (var rowKey in oldConfigObj.rows)
            {
                if (oldConfigObj.rows.hasOwnProperty(rowKey))
                {
                    var rowsString=oldConfigObj.rows[rowKey];
                    var tr=createRow(rowsString);
                    table1tbody.appendChild(tr);
                }
            }


            //初始化table2
            for(var cellEnumKey in oldConfigObj.cellEnum)
            {
                if(oldConfigObj.cellEnum.hasOwnProperty(cellEnumKey))
                {
                    var stringArray=oldConfigObj.cellEnum[cellEnumKey];
                    var tr=createRow2(cellEnumKey,stringArray);
                    table2tbody.appendChild(tr);
                }
            }


            var select=document.querySelector('select');
            var allOption=select.querySelectorAll('option');
            for(var i=0;i<allOption.length;i++)
            {
                if(allOption[i].value == oldConfigObj.splitChar)
                {
                    select.selectedIndex=i;
                    break;
                }
            }
        }


        function getKeys(obj)
        {
            var keys=[];
            for (var p1 in obj) {
                if (obj.hasOwnProperty(p1))
                    keys.push(p1);
            }
            return keys;
        }
    </script>
</body>
</html>